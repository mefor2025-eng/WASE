<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - WASE</title>
    <link rel="stylesheet" href="style.css">
</head>

<body id="page-cart">
    <header class="header"></header>

    <div class="container" style="padding-top:20px; max-width:800px;">
        <h1 class="section-title">Shopping Cart</h1>

        <div id="cart-items" class="flex flex-col gap-md">
            <!-- Items injected here -->
            <p class="text-center" style="padding:40px;">Your cart is empty.</p>
        </div>

        <div id="checkout-section" class="hidden" style="margin-top:40px; border-top:1px solid #eee; padding-top:20px;">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <span class="text-bold">Total</span>
                <span id="cart-total" class="text-bold" style="font-size:1.2rem;">â‚¹0</span>
            </div>

            <h2 class="section-title" style="margin-top:0;">Shipping Details</h2>
            <form id="checkout-form" onsubmit="handleOrder(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" name="phone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea name="address" class="form-input" rows="3" required></textarea>
                </div>
                <div class="flex gap-md">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-input" required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Pincode</label>
                        <input type="number" name="pincode" class="form-input" required>
                    </div>
                </div>

                <button type="submit" class="btn" style="width:100%; margin-top:20px; background:#25D366;">
                    <i class="ph ph-whatsapp-logo" style="margin-right:8px; font-size:1.2rem;"></i>
                    Order on WhatsApp
                </button>
            </form>
        </div>
    </div>

    <div class="mobile-nav"></div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            prefillUser();
        });

        function renderCart() {
            const container = document.getElementById('cart-items');
            const checkoutSec = document.getElementById('checkout-section');

            if (state.cart.length === 0) {
                container.innerHTML = '<p class="text-center" style="padding:40px; color:#999;">Your cart is empty.</p>';
                checkoutSec.classList.add('hidden');
                return;
            }

            checkoutSec.classList.remove('hidden');
            container.innerHTML = state.cart.map((item, index) => `
                <div class="cart-item flex gap-md items-center" style="border-bottom:1px solid #f5f5f5; padding-bottom:16px;">
                    <img src="${item.images[0]}" style="width:80px; height:80px; border-radius:4px; background:#f5f5f5;">
                    <div style="flex:1;">
                        <h3 style="font-size:1rem; font-weight:500;">${item.name}</h3>
                        <p class="text-sm">${formatPrice(item.price)}</p>
                    </div>
                    <div class="flex items-center gap-sm">
                        <button onclick="updateQty(${index}, -1)" class="btn-secondary" style="width:30px; height:30px; padding:0;">-</button>
                        <span>${item.qty}</span>
                        <button onclick="updateQty(${index}, 1)" class="btn-secondary" style="width:30px; height:30px; padding:0;">+</button>
                    </div>
                </div>
            `).join('');

            updateTotal();
        }

        function updateQty(index, change) {
            state.cart[index].qty += change;
            if (state.cart[index].qty <= 0) {
                state.cart.splice(index, 1);
            }
            saveCart();
            renderCart();
            updateCartCount();
        }

        function updateTotal() {
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('cart-total').textContent = formatPrice(total);
        }

        function prefillUser() {
            if (state.user) {
                const f = document.querySelector('form');
                if (!f) return;
                f.name.value = state.user.name || '';
                f.phone.value = state.user.phone || '';
                f.address.value = state.user.address || '';
                f.city.value = state.user.city || '';
                f.pincode.value = state.user.pincode || '';
            }
        }

        async function handleOrder(e) {
            e.preventDefault();
            const f = e.target;
            const btn = f.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = `<i class="ph ph-spinner ph-spin" style="margin-right:8px;"></i> Processing...`;

            const formData = {
                name: f.name.value,
                phone: f.phone.value,
                address: f.address.value,
                city: f.city.value,
                pincode: f.pincode.value,
                total: document.getElementById('cart-total').textContent
            };

            // 1. Save to Backend (Sheet)
            const orderPayload = {
                user_name: formData.name,
                user_phone: formData.phone,
                items: state.cart.map(i => ({ name: i.name, qty: i.qty, price: i.price, id: i.id })),
                total: formData.total,
                address: `${formData.address}, ${formData.city} - ${formData.pincode}`
            };

            await API.placeOrder(orderPayload);

            // 2. Construct WhatsApp Message
            let msg = `*New Order*\n`;
            msg += `Name: ${formData.name}\n`;
            msg += `Phone: ${formData.phone}\n`;
            msg += `Address: ${orderPayload.address}\n\n`;
            msg += `*Items:*\n`;
            state.cart.forEach(item => {
                msg += `- ${item.name} x${item.qty} (${formatPrice(item.price * item.qty)})\n`;
            });
            msg += `\n*Total: ${formData.total}*`;

            // 3. Clear Cart
            state.cart = [];
            saveCart();

            // 4. Open WhatsApp
            const url = `https://wa.me/919847420195?text=${encodeURIComponent(msg)}`;

            // Short delay to ensure UI updates if needed, then direct
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        }
    </script>
</body>

</html>